name: DGate E2E

on:
  push:
    branches: [ "**" ]
env:
  env_var: 
jobs:
  k6_load_test:
    name: k6 Load Test
    runs-on: ubuntu-latest
    env:
      PORT: 8080
      PORT_SSL: 8443
      PROXY_URL: http://localhost:8080
      ADMIN_URL: http://localhost:9080
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum
  
      - name: Build & Install
        run: |
          go mod download
          go build -v ./...
    
      - name: Install dgate-cli and dgate-server
        run: |
          go install github.com/dgate-io/dgate/cmd/dgate-cli
          dgate-cli --version
          go install github.com/dgate-io/dgate/cmd/dgate-server
          dgate-server --version
    
      - name: Install jq
        run: |
          sudo apt install -y jq
          jq --version
      
      - name: Install goreman
        run: |
          go install github.com/mattn/goreman@latest
          goreman version

      - run: go run cmd/dgate-server/main.go &

      - run: cd functional-tests/raft_tests && goreman start &

      - name: Wait for server to start
        run: sleep 5
      
      - name: Functional Standalone Tests
        run: |
          for i in functional-tests/admin_tests/*.sh; \
            do bash -c $i; done
  
      - name: Functional Distributed Tests [Node 1]
        run: |
          export ADMIN_URL=http://localhost:9081
          export PROXY_URL=http://localhost:81
          export TEST_URL=http://localhost:8081
          for i in functional-tests/admin_tests/*.sh; \
            do bash -c $i; done
  
      - name: Functional Distributed Tests [Node 2]
        run: |
          export ADMIN_URL=http://localhost:9083
          export PROXY_URL=http://localhost:83
          export TEST_URL=http://localhost:8083
          for i in functional-tests/admin_tests/*.sh; \
            do bash -c $i; done

      - name: Run local k6 test
        uses: grafana/k6-action@v0.3.1
        with:
          filename: performance-tests/perf-test.js
  
      
